#!/bin/bash

# CVE_ID="CVE-2021-25743"
CVE_ID=$1
RECORD_TIME=15
FILE_NUMBER=1
CONTAINER_ID=$(docker ps -a | grep minikube | awk '{print $1}')

OUTPUT_DIR="/CAShift/Dataset/output/attack/$CVE_ID"

if [ ! -d "$OUTPUT_DIR" ]; then
    echo "Creating Output Dir"
    mkdir -p $OUTPUT_DIR
else
    echo "Output Dir Already Exists"
fi

# get pod id
POD_ID=$(kubectl get pods | grep wordpress | awk '{print $1}')

tmux new-session -d -s attack
tmux new-session -d -s record

# setup docker env
# tmux send -t "eval \$(minikube docker-env)" "attack"
kubectl run --image=davidgl/houdini-kubectl-poc kubectl-poc

while true; do
  echo "Waiting for init pod creation..."
  sleep 2
  kubectl describe pod kubectl-poc | grep failed
  if [ $? -eq 0 ]; then
    break
  else
    echo "waiting..."
  fi
done
kubectl delete pod kubectl-poc
    
for i in {1..100}; do

    # change runc version

    # collect system log
    echo "Collecting $i ..."
    record_cmd="sudo sysdig -v -b -p \"%evt.rawtime %user.uid %proc.pid %proc.name %thread.tid %syscall.type %evt.dir %evt.args\" -w $OUTPUT_DIR/$FILE_NUMBER.scap container.id=$CONTAINER_ID"
    tmux send -t "record" "$record_cmd" ENTER

    # sleep to ensure the record is started and log start
    sleep 2
    kubectl exec -it $POD_ID -c wordpress -- logger 'Attack Start'

    terminate_cmd="kubectl exec -it $POD_ID -c wordpress -- logger 'Attack Stop' && sleep 0.5 && tmux send -t 'record' 'C-c' ENTER"
    
    kubectl run --image=davidgl/houdini-kubectl-poc kubectl-poc

    while true; do
    echo "Waiting for init pod creation..."
    sleep 2
    kubectl describe pod kubectl-poc | grep failed
    if [ $? -eq 0 ]; then
        break
    else
        echo "waiting..."
    fi
    done
    
    # Terminate
    tmux send -t "attack" "$terminate_cmd" ENTER
    kubectl delete pod kubectl-poc

    while true; do
        echo "Waiting for pod to delete..."
        sleep 1
        kubectl get pods | grep kubectl
        if [ $? -eq 0 ]; then
            echo "waiting..."
        else
            break
        fi
    done

    FILE_NUMBER=$((FILE_NUMBER + 1))
    echo "Finish $FILE_NUMBER"
done

# clean up
tmux kill-session -t attack
tmux kill-session -t record

# minikube delete